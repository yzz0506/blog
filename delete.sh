#!/bin/bash

cd "$(dirname "$0")"

echo "ğŸ”„ æ­£åœ¨åŒæ­¥äº‘ç«¯æœ€æ–°æ•°æ®..."
git pull origin main

clear
echo "================================================="
echo "           MAC åšå®¢åˆ é™¤ç»ˆç«¯ v3.1 (è‡ªåŠ¨æ¸…å›¾ç‰ˆ)"
echo "================================================="
echo ""

# 1. åˆ—å‡ºæ‰€æœ‰æ–‡ç« 
grep -n "add(" data.js

echo ""
echo "-------------------------------------------------"

# 2. è¾“å…¥è¡Œå·
read -p "[è¾“å…¥è¦åˆ é™¤çš„è¡Œå·]: " n

if [ -z "$n" ]; then
    echo "æœªè¾“å…¥ï¼Œé€€å‡ºã€‚"
    exit 1
fi

# 3. è·å–è¯¥è¡Œå†…å®¹
line_content=$(sed -n "${n}p" data.js)

if [ -z "$line_content" ]; then
    echo "âŒ é”™è¯¯ï¼šè¡Œå· $n ä¸å­˜åœ¨ã€‚"
    exit 1
fi

# 4. é¢„è§ˆå†…å®¹
echo ""
echo "âš ï¸  å³å°†åœ¨æœ¬åœ°åˆ é™¤ä»¥ä¸‹å†…å®¹ï¼š"
echo "-------------------------------------------------"
echo "${line_content:0:100}..." 
echo "-------------------------------------------------"

# === æ–°å¢ï¼šæ£€æµ‹å¹¶åˆ—å‡ºå…³è”çš„å›¾ç‰‡ ===
# ä½¿ç”¨ grep æå– src='imgs/xxx' ä¸­çš„ imgs/xxx éƒ¨åˆ†
# [^']* è¡¨ç¤ºåŒ¹é…é™¤äº†å•å¼•å·ä¹‹å¤–çš„æ‰€æœ‰å­—ç¬¦
imgs_to_delete=$(echo "$line_content" | grep -o "imgs/[^']*" )

if [ ! -z "$imgs_to_delete" ]; then
    echo "ğŸ—‘ï¸  æ£€æµ‹åˆ°å…³è”å›¾ç‰‡ï¼Œå°†ä¸€å¹¶åˆ é™¤ï¼š"
    echo "$imgs_to_delete"
    echo "-------------------------------------------------"
fi
# ==================================

read -p "ç¡®è®¤å½»åº•åˆ é™¤å—ï¼Ÿ(y/n): " confirm

if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
    echo "ğŸš« æ“ä½œå·²å–æ¶ˆã€‚"
    exit 0
fi

# 5. æ‰§è¡Œå›¾ç‰‡åˆ é™¤
if [ ! -z "$imgs_to_delete" ]; then
    # å°†å¤šè¡Œç»“æœè½¬æ¢ä¸ºæ•°ç»„æˆ–é€è¡Œå¤„ç†
    echo "$imgs_to_delete" | while read -r img_file; do
        if [ -f "$img_file" ]; then
            rm "$img_file"
            echo "âœ… å·²åˆ é™¤æ–‡ä»¶: $img_file"
        else
            echo "âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨æˆ–å·²åˆ é™¤: $img_file"
        fi
    done
fi

# 6. æ‰§è¡Œä»£ç åˆ é™¤
sed -i "" "${n}d" data.js

echo "âœ… æ•°æ®è¡Œå·²ç§»é™¤ (Line $n)"
echo "================================================="